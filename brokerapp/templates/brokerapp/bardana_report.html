{% extends 'brokerapp/base.html' %}
{% block title %}Bardana Report{% endblock %}

{% block content %}
<div class="card shadow-sm border-0 mt-3">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="fas fa-sack-xmark"></i> Bardana Report</h5>
    <small class="text-light">Filter & View your Bardana Data</small>
  </div>

  <div class="card-body">

    <!-- 🔍 FILTER BAR -->
    <form method="get" class="row g-2 align-items-end sticky-top bg-white py-2 border-bottom mb-3" style="z-index:10;">
      <div class="col-md-2 col-sm-6">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" class="form-control form-control-sm" value="{{ start_date }}">
      </div>
      <div class="col-md-2 col-sm-6">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date" class="form-control form-control-sm" value="{{ end_date }}">
      </div>
      <div class="col-md-2 col-sm-6">
        <label class="form-label">Party</label>
        <select name="party" class="form-select form-select-sm">
          <option value="all">All</option>
          {% for p in parties %}
            <option value="{{ p.pk }}" {% if selected_party == p.pk|stringformat:"s" %}selected{% endif %}>{{ p.partyname }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 col-sm-6">
        <label class="form-label">Broker</label>
        <select name="broker" class="form-select form-select-sm">
          <option value="all">All</option>
          {% for b in brokers %}
            <option value="{{ b.pk }}" {% if selected_broker == b.pk|stringformat:"s" %}selected{% endif %}>{{ b.brokername }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 col-sm-6">
        <label class="form-label">Report Type</label>
        <select name="report_type" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="date" {% if report_type == "date" %}selected{% endif %}>Date Wise</option>
          <option value="party" {% if report_type == "party" %}selected{% endif %}>Party Wise</option>
          <option value="broker" {% if report_type == "broker" %}selected{% endif %}>Broker Wise</option>
        </select>
      </div>
      <div class="col-md-2 col-sm-6">
        <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">
          <i class="fas fa-search"></i> Filter
        </button>
      </div>
    </form>

    <!-- 📊 REPORT TABLE -->
    {% if report_data %}
      {% for group in report_data %}
        <div class="table-responsive mt-4">
          <h6 class="bg-light p-2 border rounded"><i class="fas fa-layer-group"></i> {{ group.group }}</h6>
          <table class="table table-sm table-bordered align-middle text-center">
            <thead class="table-primary">
              <tr>
                <th>Date</th>
                <th>Party</th>
                <th>Broker</th>
                <th>BN</th>
                <th>BO</th>
                <th>Item</th>
              </tr>
            </thead>
            <tbody>
              {% for d in group.items %}
              <tr>
                <td>{{ d.salemaster.invdate|date:"d-m-Y" }}</td>
                <td>{{ d.salemaster.party.partyname }}</td>
                <td>{{ d.salemaster.broker.brokername }}</td>
                <td>{{ d.bn|floatformat:2 }}</td>
                <td>{{ d.bo|floatformat:2 }}</td>
                <td>{{ d.item.item_name }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <!-- ✅ TOTAL ROW ADDED -->
            <tfoot class="table-light fw-bold">
              <tr>
                <td colspan="3" class="text-end">Total</td>
                <td>{{ group.total_bn|floatformat:2 }}</td>
                <td>{{ group.total_bo|floatformat:2 }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-center mt-4 text-muted">No records found for selected filters.</p>
    {% endif %}

  </div>

  <!-- 📤 EXPORT & UTILITIES -->
  <div class="card-footer d-flex justify-content-between align-items-center">
    <div>
      <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
        <i class="fas fa-print"></i> Print
      </button>
      <button class="btn btn-outline-success btn-sm" id="exportExcel">
        <i class="fas fa-file-excel"></i> Export Excel
      </button>
    </div>
    <small class="text-muted">Report generated on {{ now|date:"d M Y, h:i A" }}</small>
  </div>
</div>

<!-- ✅ JS: Export Excel -->
<script>
document.getElementById("exportExcel").addEventListener("click", function () {
  let table = document.querySelector("table");
  if (!table) { alert("No data to export!"); return; }
  let html = table.outerHTML.replace(/ /g, '%20');
  let a = document.createElement('a');
  a.href = 'data:application/vnd.ms-excel,' + html;
  a.download = 'bardana_report.xls';
  a.click();
});
</script>
{% endblock %}
