/* Party autofill */
function fillPartyDetails(){
    const sel = document.getElementById('party');
    if(!sel) return;
    const opt = sel.options[sel.selectedIndex];
    document.getElementById('add1').value = opt.dataset.add1 || '';
    document.getElementById('add2').value = opt.dataset.add2 || '';
    document.getElementById('city').value = opt.dataset.city || '';
    document.getElementById('mobileno').value = opt.dataset.mobileno || '';
    document.getElementById('emailid').value = opt.dataset.email || '';
}
function updateDiff(){
    const p = parseFloat(document.getElementById('partywt').value) || 0;
    const m = parseFloat(document.getElementById('millwt').value) || 0;
    document.getElementById('diffwt').value = (p - m).toFixed(2);
}

/* Items */
let itemsArray = JSON.parse(document.getElementById('itemsJson').value || '[]');
let editingIndex = null;

function calcLineAmount(){
    const qty = parseFloat(document.getElementById('qty').value) || 0;
    const rate = parseFloat(document.getElementById('rate').value) || 0;
    document.getElementById('lineAmount').value = (qty * rate).toFixed(2);
}
document.getElementById('qty').addEventListener('input', calcLineAmount);
document.getElementById('rate').addEventListener('input', calcLineAmount);

document.getElementById('addItemBtn').addEventListener('click', function(){
    const itemSelect = document.getElementById('itemSelect');
    const itemId = itemSelect.value;
    const itemName = itemSelect.options[itemSelect.selectedIndex]?.text || '';
    if(!itemId){ alert('Select item'); return; }

    const bora = parseFloat(document.getElementById('bora').value) || 0;
    const qty = parseFloat(document.getElementById('qty').value) || 0;
    const rate = parseFloat(document.getElementById('rate').value) || 0;
    const amt = parseFloat((qty * rate).toFixed(2)) || 0;
    const partywt = parseFloat(document.getElementById('partywt').value) || 0;
    const millwt = parseFloat(document.getElementById('millwt').value) || 0;
    const diffwt = parseFloat((partywt - millwt).toFixed(2)) || 0;

    const newItem = { item_id:itemId, item_name:itemName, bora, qty, rate, amt, partywt, millwt, diffwt };

    if(editingIndex !== null){
        itemsArray[editingIndex] = newItem;
        editingIndex = null;
        this.textContent = "Add Item";
        this.classList.remove("btn-primary");
        this.classList.add("btn-success");
    } else {
        itemsArray.push(newItem);
    }

    updateUI();

    // Reset form
    document.getElementById('bora').value='';
    document.getElementById('qty').value='';
    document.getElementById('rate').value='';
    document.getElementById('lineAmount').value='';
    document.getElementById('partywt').value='';
    document.getElementById('millwt').value='';
    document.getElementById('diffwt').value='';
    itemSelect.value='';
});

function updateUI(){
    const tbody = document.getElementById('addedItemsTableBody');
    tbody.innerHTML = '';
    let total = 0;
    itemsArray.forEach((it, idx) => {
        total += Number(it.amt || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${it.item_name}</td>
                        <td>${it.bora}</td>
                        <td>${it.qty}</td>
                        <td>${it.rate}</td>
                        <td>${it.amt}</td>
                        <td>${it.partywt}</td>
                        <td>${it.millwt}</td>
                        <td>${it.diffwt}</td>
                        <td>
                          <button type="button" class="btn btn-warning btn-sm" onclick="editItem(${idx})">Update</button>
                          <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${idx})">Remove</button>
                        </td>`;
        tbody.appendChild(tr);
    });
    document.getElementById('totalamt').value = total.toFixed(2);
    updateSummary();
    document.getElementById('itemsJson').value = JSON.stringify(itemsArray);
}
function removeItem(index){ itemsArray.splice(index,1); updateUI(); }

function editItem(idx){
    const item = itemsArray[idx];
    editingIndex = idx;
    const itemSelect = document.getElementById('itemSelect');
    itemSelect.value = item.item_id;
    document.getElementById('bora').value = item.bora;
    document.getElementById('qty').value = item.qty;
    document.getElementById('rate').value = item.rate;
    document.getElementById('lineAmount').value = item.amt;
    document.getElementById('partywt').value = item.partywt;
    document.getElementById('millwt').value = item.millwt;
    document.getElementById('diffwt').value = item.diffwt;

    const addBtn = document.getElementById('addItemBtn');
    addBtn.textContent = "Update Item";
    addBtn.classList.remove("btn-success");
    addBtn.classList.add("btn-primary");
}

/* Summary for Purchase (Dalali subtracts) */
function updateSummary(){
    let totalamt = parseFloat(document.getElementById('totalamt').value) || 0;
    let borapercent = parseFloat(document.getElementById('borapercent').value) || 0;
    let boraamt = (totalamt * borapercent / 100);
    document.getElementById('boraamt').value = boraamt.toFixed(2);

    let dr = parseFloat(document.getElementById('dr').value) || 0;
    let dramt = -(totalamt * dr / 100);  // **Subtract Dalali for Purchase**
    document.getElementById('dramt').value = dramt.toFixed(2);

    let other = parseFloat(document.getElementById('other').value) || 0;
    let total = totalamt - boraamt - dramt - other;  // dramt negative => added
    document.getElementById('total').value = total.toFixed(2);

    let advance = parseFloat(document.getElementById('advance').value) || 0;
    let netamt = total - advance;
    document.getElementById('netamt').value = netamt.toFixed(2);

    updateAmtInWords(netamt);
}

function updateAmtInWords(num){
    fetch(`/num-to-words/?num=${num}`)
        .then(r=>r.json())
        .then(d=>{ document.getElementById("amt_in_words").value = d.words || ''; })
        .catch(()=>{ document.getElementById("amt_in_words").value = ""; });
}

document.querySelectorAll('#borapercent,#dr,#other,#advance').forEach(el => {
    el.addEventListener('input', updateSummary);
});

document.addEventListener('DOMContentLoaded', function(){
    fillPartyDetails();
    if(itemsArray.length) updateUI();
});
