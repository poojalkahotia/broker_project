{% extends 'brokerapp/base.html' %}
{% block title %}Sale Report{% endblock %}

{% block content %}
<div class="card shadow-sm border-0 mt-3">
  <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Sale Report</h5>
    <small class="text-light">Filter & View Sale Summary</small>
  </div>

  <div class="card-body">

    <!-- ðŸ” FILTER BAR -->
    <form method="get" class="row g-2 align-items-end sticky-top bg-white py-2 border-bottom mb-3" style="z-index:10;">
      <div class="col-md-2 col-sm-6">
        <label class="form-label">Start Date</label>
        <input type="date" name="start_date" class="form-control form-control-sm" value="{{ start_date }}">
      </div>

      <div class="col-md-2 col-sm-6">
        <label class="form-label">End Date</label>
        <input type="date" name="end_date" class="form-control form-control-sm" value="{{ end_date }}">
      </div>

      <div class="col-md-3 col-sm-6">
        <label class="form-label">Broker</label>
        <select name="broker" class="form-select form-select-sm">
          <option value="all">All</option>
          {% for b in brokers %}
            <option value="{{ b.brokername }}" {% if selected_broker == b.brokername %}selected{% endif %}>
              {{ b.brokername }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-3 col-sm-6">
        <label class="form-label">Report Type</label>
        <select name="report_type" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="date" {% if report_type == "date" %}selected{% endif %}>Date Wise</option>
          <option value="broker" {% if report_type == "broker" %}selected{% endif %}>Date + Broker Wise</option>
        </select>
      </div>

      <div class="col-md-2 col-sm-6">
        <button type="submit" class="btn btn-primary btn-sm w-100 mt-2">
          <i class="fas fa-search"></i> Filter
        </button>
      </div>
    </form>

    <!-- ðŸ“Š REPORT TABLE -->
    {% if report_data %}
      {% for group in report_data %}
        <div class="table-responsive mt-4">
          <h6 class="bg-light p-2 border rounded">
            <i class="fas fa-layer-group"></i> {{ group.group }}
          </h6>

          <table class="table table-sm table-bordered align-middle text-center">
            <thead class="table-primary">
              <tr>
                <th>Invoice No</th>
                <th>Invoice Date</th>
                <th>Broker</th>
                <th>Total Amt</th>
                <th>Batav Amt</th>
                <th>DR Amt</th>
                <th>Other</th>
                <th>Total</th>
                <th>Advance</th>
                <th>Net Amt</th>
              </tr>
            </thead>

            <tbody>
              {% for s in group.items %}
              <tr>
                <td>{{ s.invno }}</td>
                <td>{{ s.invdate|date:"d-m-Y" }}</td>
                <td>{{ s.broker.brokername }}</td>
                <td>{{ s.totalamt|floatformat:2 }}</td>
                <td>{{ s.batavamt|floatformat:2 }}</td>
                <td>{{ s.dramt|floatformat:2 }}</td>
                <td>{{ s.other|floatformat:2 }}</td>
                <td>{{ s.total|floatformat:2 }}</td>
                <td>{{ s.advance|floatformat:2 }}</td>
                <td>{{ s.netamt|floatformat:2 }}</td>
              </tr>

              <!-- Details with TBWt -->
              <tr>
                <td colspan="10" class="p-0">
                  <table class="table table-bordered table-sm mb-0">
                    <thead class="table-light">
                      <tr class="text-center">
                        <th style="width:18%">Item</th>
                        <th style="width:10%">Bora</th>
                        <th style="width:10%">TBWt</th>
                        <th style="width:10%">Qty</th>
                        <th style="width:10%">Rate</th>
                        <th style="width:12%">Amount</th>
                        <th style="width:10%">PartyWt</th>
                        <th style="width:10%">MillWt</th>
                        <th style="width:10%">DiffWt</th>
                        <th style="width:10%">Lot No</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in s.details.all %}
                      <tr class="text-center">
                        <td class="text-start">{{ d.item.item_name }}</td>
                        <td>{{ d.bora|floatformat:2 }}</td>
                        <td>{{ d.tbwt|floatformat:2 }}</td>
                        <td>{{ d.qty|floatformat:2 }}</td>
                        <td>{{ d.rate|floatformat:2 }}</td>
                        <td>{{ d.amount|floatformat:2 }}</td>
                        <td>{{ d.partywt|floatformat:2 }}</td>
                        <td>{{ d.millwt|floatformat:2 }}</td>
                        <td>{{ d.diffwt|floatformat:2 }}</td>
                        <td>{{ d.lotno }}</td>
                      </tr>
                      {% empty %}
                      <tr><td colspan="10" class="text-center text-muted">No items</td></tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </td>
              </tr>
              {% endfor %}
            </tbody>

            <!-- Group Totals -->
            <tfoot class="table-secondary fw-bold">
              <tr>
                <td colspan="3" class="text-end">Group Totals:</td>
                <td>{{ group.totals.total_totalamt|floatformat:2 }}</td>
                <td>{{ group.totals.total_batavamt|floatformat:2 }}</td>
                <td>{{ group.totals.total_dramt|floatformat:2 }}</td>
                <td>{{ group.totals.total_other|floatformat:2 }}</td>
                <td>{{ group.totals.total_total|floatformat:2 }}</td>
                <td>{{ group.totals.total_advance|floatformat:2 }}</td>
                <td>{{ group.totals.total_netamt|floatformat:2 }}</td>
              </tr>
              {% if group.totals.total_tbwt %}
              <tr>
                <td colspan="3" class="text-end">Group TBWt:</td>
                <td colspan="7" class="text-start">{{ group.totals.total_tbwt|floatformat:2 }}</td>
              </tr>
              {% endif %}
            </tfoot>
          </table>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-center text-muted mt-4">No sales found for selected filters.</p>
    {% endif %}

    <!-- ðŸŒ OVERALL TOTALS (vertical stacked layout) -->
    <div class="card mt-4 border-0 shadow-sm">
      <div class="card-body bg-light overall-totals-vertical">
        <h6 class="fw-bold text-primary mb-3">
          <i class="fas fa-sigma"></i> Overall Totals
        </h6>
        <div class="totals-box">
          <div class="total-line"><span>Total Amt:</span> <strong>{{ overall_totals.total_totalamt|floatformat:2 }}</strong></div>
          <div class="total-line"><span>Batav Amt:</span> <strong>{{ overall_totals.total_batavamt|floatformat:2 }}</strong></div>
          <div class="total-line"><span>DR Amt:</span> <strong>{{ overall_totals.total_dramt|floatformat:2 }}</strong></div>
          <div class="total-line"><span>Other:</span> <strong>{{ overall_totals.total_other|floatformat:2 }}</strong></div>
          <div class="total-line"><span>Advance:</span> <strong>{{ overall_totals.total_advance|floatformat:2 }}</strong></div>
          {% if overall_totals.total_tbwt %}
          <div class="total-line"><span>Total TBWt:</span> <strong>{{ overall_totals.total_tbwt|floatformat:2 }}</strong></div>
          {% endif %}
          <div class="total-line border-top pt-2 mt-2"><span>Net Amt:</span> <strong>{{ overall_totals.total_netamt|floatformat:2 }}</strong></div>
        </div>
      </div>
    </div>

    <!-- ðŸ“¤ EXPORT OPTIONS -->
    <div class="card-footer d-flex justify-content-between align-items-center d-print-none">
      <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
          <i class="fas fa-print"></i> Print
        </button>
        <button class="btn btn-outline-success btn-sm" id="exportExcel">
          <i class="fas fa-file-excel"></i> Export Excel
        </button>
         <!-- PDF: added id so JS can trigger it via shortcut -->
        <a id="exportPdf" class="btn btn-outline-danger btn-sm"
           href="{% url 'sale_report_pdf' %}?{{ request.GET.urlencode }}"
           target="_blank" rel="noopener">
           <i class="fas fa-file-pdf"></i> PDF
       </a>
      </div>
      <small class="text-muted">Report generated on {{ now|date:"d M Y, h:i A" }}</small>
    </div>
  </div>
</div>

<!-- âœ… JS: Export Excel (exports the first/summary table on the page) -->
<script>
document.getElementById("exportExcel").addEventListener("click", function () {
  let table = document.querySelector("table");
  if (!table) { alert("No data to export!"); return; }
  let html = table.outerHTML.replace(/ /g, '%20');
  let a = document.createElement('a');
  a.href = 'data:application/vnd.ms-excel,' + html;
  a.download = 'sale_report.xls';
  a.click();
});

// Robust page-level keyboard shortcuts â€” use keyup to avoid conflict with global Enter keydown handlers
document.addEventListener('keyup', function(e){
  try {
    const active = document.activeElement;
    const tag = active && active.tagName;
    // Ignore when user is typing in an input/textarea or contenteditable
    if (tag === 'INPUT' || tag === 'TEXTAREA' || (active && active.isContentEditable)) return;

    // need both Ctrl + Shift for shortcuts
    if (!(e.ctrlKey && e.shiftKey)) return;

    // Normalize key value
    const key = (e.key || '').toUpperCase();

    // Ctrl+Shift+E => Excel
    if (key === 'E') {
      const btn = document.getElementById('exportExcel');
      if (btn) {
        e.preventDefault();
        btn.click();
      }
      return;
    }

    // Ctrl+Shift+P => PDF
    if (key === 'P') {
      const link = document.getElementById('exportPdf');
      if (link) {
        e.preventDefault();
        link.click();
      }
      return;
    }
  } catch (err) {
    // ignore errors silently â€” shortcuts are optional
    console.warn('shortcut handler error', err);
  }
});
</script>
{% endblock %}
